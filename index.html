<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حكايتنا - إدارة المبدعين والأرباح</title>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #f39c12;
            --dark-bg-main: #1c1c20;
            --dark-bg-secondary: #28282d;
            --card-bg: #323238;
            --text-light: #ecf0f1;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Almarai', sans-serif;
            background: var(--dark-bg-main);
            color: var(--text-light);
            margin: 0;
            direction: rtl;
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }

        /* Stats Card */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary-color); }
        .stat-card i { font-size: 2rem; color: var(--secondary-color); margin-bottom: 10px; }
        .stat-card h3 { margin: 5px 0; font-size: 1.5rem; }

        /* Form Styling */
        .form-section { background: var(--dark-bg-secondary); padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #444; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a1e; color: white; box-sizing: border-box; }
        
        button { cursor: pointer; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary-color); color: white; width: 100%; margin-top: 10px; }
        .btn-main:hover { background: #c0392b; }

        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
    </style>
</head>
<body>

<div id="lock-screen">
    <i class="fas fa-user-lock" style="font-size: 5rem; color: var(--danger-color);"></i>
    <h1>عذراً، هذا الحساب مرتبط بجهاز آخر!</h1>
    <p>لا يمكنك الدخول إلى لوحة التحكم إلا من الجهاز المصرح به فقط.</p>
</div>

<header style="background: var(--dark-bg-secondary); padding: 15px 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-color);">
    <h2>لوحة تحكم المبدعين - حكايتنا</h2>
    <div>
        <span id="user-display-name">جاري التحميل...</span>
        <button onclick="logout()" style="background: #e74c3c; color: white; margin-right: 15px;">خروج</button>
    </div>
</header>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-wallet"></i>
            <p>أرباحك الحالية</p>
            <h3 id="user-balance">0.00 $</h3>
        </div>
        <div class="stat-card">
            <i class="fas fa-tv"></i>
            <p>المسلسلات المكتملة</p>
            <h3 id="completed-series">0</h3>
        </div>
    </div>

    <div class="form-section">
        <h3><i class="fas fa-upload"></i> رفع عمل جديد</h3>
        <div class="form-group">
            <label>عنوان المسلسل</label>
            <input type="text" id="series-title" placeholder="مثال: المؤسس عثمان">
        </div>
        <div class="form-group">
            <label>حالة المسلسل</label>
            <select id="series-status">
                <option value="ongoing">مستمر (لن يحسب ربح الآن)</option>
                <option value="completed">مكتمل (سيتم إضافة 0.05$ فوراً)</option>
            </select>
        </div>
        <div class="form-group">
            <label>رابط الصورة</label>
            <input type="url" id="series-image" placeholder="https://example.com/image.jpg">
        </div>
        <button class="btn-main" id="add-series-btn">إضافة المسلسل وبدء رفع الحلقات</button>
    </div>

    <div id="management-area" style="display:none;">
        <div class="form-section" style="border-color: var(--success-color);">
            <h3>إضافة حلقات لـ: <span id="current-series-name" style="color: var(--secondary-color);"></span></h3>
            <p style="font-size: 13px; color: #aaa;">رقم المسلسل (ID): <span id="current-series-id"></span></p>
            <div class="form-group">
                <input type="text" id="ep-title" placeholder="اسم الحلقة (مثلاً: الحلقة 1)">
                <input type="url" id="ep-link" placeholder="رابط المشغل (Embed Link)" style="margin-top:10px;">
            </div>
            <button id="save-ep-btn" class="btn-main" style="background: var(--success-color);">حفظ الحلقة ونشرها</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, increment, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEaxXR5eqzg0e5JvjWAFjZ5ZeMraMYREn",
        authDomain: "mo-play-b0cb7.firebaseapp.com",
        databaseURL: "https://mo-play-b0cb7-default-rtdb.firebaseio.com",
        projectId: "mo-play-b0cb7",
        storageBucket: "mo-play-b0cb7.firebasestorage.app",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let activeSeriesId = null;
    const deviceFingerprint = btoa(navigator.userAgent + navigator.language + screen.width);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userSnap = await get(ref(db, `admins/${user.uid}`));
            if (userSnap.exists()) {
                const userData = userSnap.val();
                
                // نظام قفل الجهاز
                if (userData.deviceId && userData.deviceId !== deviceFingerprint) {
                    document.getElementById('lock-screen').style.display = 'flex';
                    return;
                } else if (!userData.deviceId) {
                    await update(ref(db, `admins/${user.uid}`), { deviceId: deviceFingerprint });
                }

                document.getElementById('user-display-name').innerText = "مرحباً: " + (userData.name || "أدمن");
                document.getElementById('user-balance').innerText = (userData.balance || 0).toFixed(2) + " $";
                document.getElementById('completed-series').innerText = userData.completedCount || 0;
            } else {
                alert("ليس لديك صلاحيات دخول");
                window.location.href = "login.html";
            }
        } else {
            window.location.href = "login.html";
        }
    });

    // إضافة مسلسل جديد
    document.getElementById('add-series-btn').onclick = async () => {
        const title = document.getElementById('series-title').value.trim();
        const status = document.getElementById('series-status').value;
        const image = document.getElementById('series-image').value.trim();

        if (!title || !image) return alert("يرجى إكمال كافة البيانات");

        const seriesId = "series_" + Date.now(); // معرف فريد للمسلسل
        const seriesData = {
            id: seriesId,
            title: title,
            status: status,
            image: image,
            uploaderId: auth.currentUser.uid,
            views: 0,
            likes: 0
        };

        try {
            await set(ref(db, `series/${seriesId}`), seriesData);

            if (status === 'completed') {
                await update(ref(db, `admins/${auth.currentUser.uid}`), {
                    balance: increment(0.05),
                    completedCount: increment(1)
                });
            }

            // إظهار منطقة إضافة الحلقات للمسلسل الحالي
            activeSeriesId = seriesId;
            document.getElementById('current-series-name').innerText = title;
            document.getElementById('current-series-id').innerText = seriesId;
            document.getElementById('management-area').style.display = 'block';
            
            alert("تم إنشاء المسلسل بنجاح! يمكنك الآن إضافة الحلقات بالأسفل.");
            window.scrollTo(0, document.body.scrollHeight);
        } catch (e) {
            alert("خطأ في القاعدة: " + e.message);
        }
    };

    // إضافة حلقات للمسلسل النشط
    window.addEpisode = async () => {
        const epTitle = document.getElementById('ep-title').value.trim();
        const epLink = document.getElementById('ep-link').value.trim();

        if (!activeSeriesId) return alert("يرجى إضافة مسلسل أولاً");
        if (!epTitle || !epLink) return alert("أكمل بيانات الحلقة");

        try {
            const epRef = ref(db, `series/${activeSeriesId}/episodes`);
            const newEpRef = push(epRef); // إضافة الحلقة كعنصر جديد في القائمة
            await set(newEpRef, {
                title: epTitle,
                link1: epLink // الرابط الأساسي
            });

            alert("تم نشر " + epTitle + " بنجاح!");
            document.getElementById('ep-title').value = "";
            document.getElementById('ep-link').value = "";
        } catch (e) {
            alert("فشل إضافة الحلقة: " + e.message);
        }
    };

    // ربط الزر بالدالة
    document.getElementById('save-ep-btn').onclick = window.addEpisode;

    window.logout = () => signOut(auth).then(() => location.reload());
</script>

</body>
</html>
