<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حكايتنا - إدارة المبدعين والأرباح</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@500;700&family=Almarai:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #f39c12;
            --dark-bg-main: #1c1c20;
            --dark-bg-secondary: #28282d;
            --card-bg: #323238;
            --text-light: #ecf0f1;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
        }

        body { font-family: 'Almarai', sans-serif; background: var(--dark-bg-main); color: var(--text-light); margin: 0; direction: rtl; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        
        /* Stats Card */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary-color); }
        .stat-card i { font-size: 2rem; color: var(--secondary-color); margin-bottom: 10px; }
        .stat-card h3 { margin: 5px 0; font-size: 1.5rem; }

        /* Form Styling */
        .form-section { background: var(--dark-bg-secondary); padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #444; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #1a1a1e; color: white; box-sizing: border-box; }
        
        button { cursor: pointer; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-main { background: var(--primary-color); color: white; width: 100%; }
        .btn-main:hover { background: #c0392b; }

        /* User Lock Alert */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        
        .badge { padding: 4px 10px; border-radius: 5px; font-size: 12px; margin-right: 5px; }
        .badge-success { background: var(--success-color); }
        .badge-warning { background: var(--secondary-color); }
    </style>
</head>
<body>

<div id="lock-screen">
    <i class="fas fa-user-lock" style="font-size: 5rem; color: var(--danger-color);"></i>
    <h1>عذراً، هذا الحساب مرتبط بجهاز آخر!</h1>
    <p>لا يمكنك الدخول إلى لوحة التحكم إلا من الجهاز المصرح به فقط.</p>
</div>

<div class="admin-header" style="background: var(--dark-bg-secondary); padding: 15px 50px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary-color);">
    <h2>لوحة تحكم المبدعين - حكايتنا</h2>
    <div>
        <span id="user-display-name">جاري التحميل...</span>
        <button onclick="logout()" style="background: #e74c3c; margin-right: 15px;">خروج</button>
    </div>
</div>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card">
            <i class="fas fa-wallet"></i>
            <p>أرباحك الحالية</p>
            <h3 id="user-balance">0.00 $</h3>
        </div>
        <div class="stat-card">
            <i class="fas fa-tv"></i>
            <p>المسلسلات المكتملة</p>
            <h3 id="completed-series">0</h3>
        </div>
    </div>

    <div class="form-section">
        <h3><i class="fas fa-upload"></i> رفع عمل جديد</h3>
        <div class="form-group">
            <label>عنوان المسلسل</label>
            <input type="text" id="series-title" placeholder="مثال: المؤسس عثمان">
        </div>
        <div class="form-group">
            <label>حالة المسلسل</label>
            <select id="series-status">
                <option value="ongoing">مستمر (لن يحسب ربح الآن)</option>
                <option value="completed">مكتمل (سيتم إضافة 0.05$ عند الانتهاء من رفع الحلقات)</option>
            </select>
        </div>
        <div class="form-group">
            <label>رابط الصورة</label>
            <input type="url" id="series-image">
        </div>
        <button class="btn-main" id="add-series-btn">إضافة المسلسل وبدء رفع الحلقات</button>
    </div>

    <div id="management-area" style="display:none;">
        <div class="form-section" style="border-color: var(--success-color);">
            <h3>إضافة حلقات لـ <span id="current-series-name"></span></h3>
            <div class="form-group">
                <input type="text" id="ep-title" placeholder="اسم الحلقة (مثلاً: الحلقة 1)">
                <input type="url" id="ep-link" placeholder="رابط المشغل" style="margin-top:10px;">
            </div>
            <button onclick="addEpisode()" class="btn-main" style="background: var(--success-color);">حفظ الحلقة</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update, increment } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCEaxXR5eqzg0e5JvjWAFjZ5ZeMraMYREn",
        authDomain: "mo-play-b0cb7.firebaseapp.com",
        databaseURL: "https://mo-play-b0cb7-default-rtdb.firebaseio.com",
        projectId: "mo-play-b0cb7",
        storageBucket: "mo-play-b0cb7.firebasestorage.app",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let deviceFingerprint = btoa(navigator.userAgent + navigator.language + screen.width); // بصمة الجهاز البسيطة

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const userSnap = await get(ref(db, `admins/${user.uid}`));
            if (userSnap.exists()) {
                const userData = userSnap.val();
                
                // نظام قفل الجهاز (Device Lock)
                if (userData.deviceId && userData.deviceId !== deviceFingerprint) {
                    document.getElementById('lock-screen').style.display = 'flex';
                    return;
                } else if (!userData.deviceId) {
                    // أول دخول للمستخدم - ربط الجهاز
                    await update(ref(db, `admins/${user.uid}`), { deviceId: deviceFingerprint });
                }

                currentUser = userData;
                document.getElementById('user-display-name').innerText = "مرحباً: " + userData.name;
                document.getElementById('user-balance').innerText = (userData.balance || 0).toFixed(2) + " $";
                document.getElementById('completed-series').innerText = userData.completedCount || 0;
            } else {
                window.location.href = "login.html"; // إذا لم يكن أدمن
            }
        } else {
            window.location.href = "login.html";
        }
    });

    // إضافة مسلسل ونظام الأرباح
    document.getElementById('add-series-btn').onclick = async () => {
        const title = document.getElementById('series-title').value;
        const status = document.getElementById('series-status').value;
        const image = document.getElementById('series-image').value;

        if (!title || !image) return alert("اكمل البيانات");

        const seriesId = title.replace(/\s+/g, '_');
        const seriesData = {
            title,
            status,
            image,
            uploaderId: auth.currentUser.uid,
            episodes: []
        };

        try {
            await set(ref(db, `series/${seriesId}`), seriesData);
            
            // إذا كان المسلسل مكتمل، يتم إضافة ربح (مثلاً 0.05 دولار)
            if (status === 'completed') {
                await update(ref(db, `admins/${auth.currentUser.uid}`), {
                    balance: increment(0.05),
                    completedCount: increment(1)
                });
                alert("تم إضافة المسلسل وحساب 0.05$ في رصيدك!");
            } else {
                alert("تم إضافة المسلسل (مستمر)، سيتم احتساب الربح عند اكتماله مستقبلاً.");
            }
            
            location.reload(); 
        } catch (e) {
            alert("خطأ: " + e.message);
        }
    };

    window.logout = () => signOut(auth).then(() => location.reload());

</script>
</body>
</html>
